machine:
  services:
    - docker

checkout:
  post:
    - git fetch --unshallow 2>/dev/null || true
    - git fetch --tags
    - HOME=foo go get -d -u github.com/cockroachdb/build-cache
    - HOME=foo go get -u github.com/robfig/glock
    - grep -v '^cmd' GLOCKFILE | glock sync -n

dependencies:
  cache_directories:
    - "~/docker"
  override:
    # Pretend we're already bootstrapped, so that `make` doesn't try to get us
    # started which is impossible without a working Go env.
    - touch .bootstrap && make '.git/hooks/*'
    # If there's a base image cached, load it. A click on CircleCI's "Clear
    # Cache" will make sure we start with a clean slate.
    - mkdir -p ~/docker && ls -lh ~/docker
    - |
      if [[ ! -e ~/docker/builder.tar ]]; then
        docker pull "cockroachdb/builder" && docker save "cockroachdb/builder" > ~/docker/builder.tar
      else
      	docker load -i ~/docker/builder.tar
      fi
  post:
    - rm -f ~/docker/{base,dnsmasq}.tar

test:
  override:
    - ls -lhR ~/.go_workspace/pkg
    - build/circle-build.sh go install github.com/cockroachdb/build-cache
    - build/circle-build.sh build-cache restore ./util/encoding
    - build/circle-build.sh go install ./util/encoding
    - build/circle-build.sh build-cache save ./util/encoding
    - ls -lhR ~/.go_workspace/pkg
